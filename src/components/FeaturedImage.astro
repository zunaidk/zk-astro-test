---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface Props {
  src: string | ImageMetadata | null | undefined;
  alt: string;
  class?: string;
  priority?: boolean;
  width?: number;
  height?: number;
}

const { 
  src, 
  alt, 
  class: className = 'w-full h-auto rounded-lg',
  priority = false,
  width = 1200,
  height = 630,
} = Astro.props;

if (!src) return null;

// Already imported ImageMetadata
const isImported = typeof src === 'object' && 'src' in src;

// Remote URL
const isRemote = typeof src === 'string' && src.startsWith('http');

// Glob all images in src/media - official Astro pattern
// Includes both /src/media/ (user images) and /src/media/cms/ (WordPress imports)
const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/media/**/*.{jpeg,jpg,png,gif,webp,avif,svg}'
);

// Load blur placeholders (generated by sync-media script)
let placeholders: Record<string, { base64: string; width: number; height: number }> = {};
try {
  const placeholderModule = await import('../lib/image-placeholders.json');
  placeholders = placeholderModule.default || placeholderModule;
} catch (e) {
  // No placeholders file yet - that's fine
}

// Build lookup path for local images
let imagePath: string | null = null;
let resolvedImage: ImageMetadata | null = null;

if (!isImported && !isRemote && typeof src === 'string') {
  const filename = src.split('/').pop() || '';
  // Get base filename without extension (for matching across formats)
  const baseFilename = filename.replace(/\.[^.]+$/, '').toLowerCase();
  
  // Check if path is already specified
  if (src.startsWith('/src/media/')) {
    imagePath = src;
  } else if (src.startsWith('src/media/')) {
    imagePath = '/' + src;
  } else {
    // Try to find by base filename in src/media/cms/ or src/media/
    // This handles cases where public/ has .webp but src/ has .jpg/.png
    for (const path of Object.keys(images)) {
      const pathFilename = path.split('/').pop() || '';
      const pathBase = pathFilename.replace(/\.[^.]+$/, '').toLowerCase();
      if (pathBase === baseFilename) {
        imagePath = path;
        break;
      }
    }
  }
  
  // Resolve the dynamic import - MUST await and access .default
  if (imagePath && images[imagePath]) {
    const imageModule = await images[imagePath]();
    resolvedImage = imageModule.default;
  }
}

// Look up blur placeholder for this image
let blurDataUrl: string | null = null;
if (typeof src === 'string' && !priority) {
  const srcFilename = src.split('/').pop() || '';
  const lookupBase = srcFilename.replace(/\.[^.]+$/, '').toLowerCase();
  // Try direct match, then base name match
  for (const [key, value] of Object.entries(placeholders)) {
    const keyBase = key.replace(/\.[^.]+$/, '').toLowerCase();
    if (keyBase === lookupBase) {
      blurDataUrl = value.base64;
      break;
    }
  }
}
---

{blurDataUrl && !priority ? (
  <div class="relative overflow-hidden" style={`aspect-ratio: ${width}/${height}`}>
    <img
      src={blurDataUrl}
      alt=""
      aria-hidden="true"
      class={`absolute inset-0 w-full h-full object-cover scale-110 blur-xl ${className}`}
      style="filter: blur(20px); transform: scale(1.1);"
    />
    {isImported ? (
      <Image 
        src={src as ImageMetadata}
        alt={alt}
        width={width}
        height={height}
        loading="lazy"
        class={`relative z-10 ${className}`}
        quality={80}
        format="webp"
        style="animation: fadeIn 0.3s ease-out forwards;"
      />
    ) : isRemote ? (
      <Image 
        src={src as string}
        alt={alt}
        width={width}
        height={height}
        loading="lazy"
        class={`relative z-10 ${className}`}
        quality={80}
        format="webp"
        style="animation: fadeIn 0.3s ease-out forwards;"
      />
    ) : resolvedImage ? (
      <Image 
        src={resolvedImage}
        alt={alt}
        width={width}
        height={height}
        loading="lazy"
        class={`relative z-10 ${className}`}
        quality={80}
        format="webp"
        style="animation: fadeIn 0.3s ease-out forwards;"
      />
    ) : (
      <img 
        src={typeof src === 'string' ? src : ''}
        alt={alt}
        width={width}
        height={height}
        loading="lazy"
        class={`relative z-10 ${className}`}
        style="animation: fadeIn 0.3s ease-out forwards;"
      />
    )}
  </div>
) : isImported ? (
  <Image 
    src={src as ImageMetadata}
    alt={alt}
    width={width}
    height={height}
    loading={priority ? 'eager' : 'lazy'}
    class={className}
    quality={80}
    format="webp"
  />
) : isRemote ? (
  <Image 
    src={src as string}
    alt={alt}
    width={width}
    height={height}
    loading={priority ? 'eager' : 'lazy'}
    class={className}
    quality={80}
    format="webp"
  />
) : resolvedImage ? (
  <Image 
    src={resolvedImage}
    alt={alt}
    width={width}
    height={height}
    loading={priority ? 'eager' : 'lazy'}
    class={className}
    quality={80}
    format="webp"
  />
) : (
  <img 
    src={typeof src === 'string' ? src : ''}
    alt={alt}
    width={width}
    height={height}
    loading={priority ? 'eager' : 'lazy'}
    class={className}
  />
)}

<style is:global>
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
</style>
